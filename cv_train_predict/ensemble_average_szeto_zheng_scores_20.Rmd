---
title: "Averge of predicted scores from 20 models"
author: "Si Liu"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: journal
    highlight: tango
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: true
      smooth_scroll: false
    number_sections: false
    code_folding: hide
    df_print: paged
params:
  timepoint: baseline
---
  
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(dev = "png", dev.args = list(type = "cairo-png"), dpi=300)
options(bitmapType='cairo') # for generating png on linux
```

# Setup

## Loading libraries. 

```{r load_libraries, warning = FALSE, message = FALSE}
library(ggplot2)
theme_set(theme_classic())
library(ggpubr)
library(ggpointdensity)
library(viridis)
library(pROC)

```

```{r}

n_model = 20

data_list = c("HLA_I_all_match_szeto", "HLA_I_all_match_zheng")
```

# Take average of scores

```{r}

df_seeds = read.table("ensemble_seeds.txt", sep = "\t", header=FALSE)
dim(df_seeds)
head(df_seeds)

for (cur_data in data_list){
  
  print(cur_data)
  
  score_dir = paste0("results/predicted_scores/", cur_data, "_ensemble/")

  test_list = c()

  for (i in 1:n_model){
    
    seed_1 = as.character(df_seeds$V1[i])
    seed_2 = as.character(df_seeds$V2[i])
    seed_3 = as.character(df_seeds$V3[i])
    
    seeds_string = paste0("_", seed_1, "_", seed_2, "_", seed_3)
    
    df_test = read.csv(paste0(score_dir, cur_data, seeds_string, 
                                   "/predicted_scores.csv"), 
                            header=TRUE)    

    test_list[[i]] = df_test$score
    
  }

  print(length(test_list))

  test_mat = matrix(unlist(test_list), ncol=n_model, byrow=FALSE)
  
  print(dim(test_mat))
  
  stopifnot(all(test_mat[1:5, 11] == test_list[[11]][1:5]))

  
  # Save Out Files of Averaged Scores
  
  ave_test = rowSums(test_mat[, 1:n_model])/n_model

  
  df_ave_test = data.frame(tcr = df_test$tcr, 
                           hla_allele = df_test$hla_allele, 
                           ave = ave_test)
  
  write.csv(df_ave_test, 
            paste0("results/ensemble_scores/", cur_data, "/", cur_data, "_", as.character(n_model), ".csv"), 
            row.names=FALSE)


  # summary
  print(paste0(cur_data, " summary:"))
  print(summary(df_ave_test$ave))
  print("                                          ")
  print("------------------------------------------")


}

```
# Session information
```{r}
sessionInfo()
```

